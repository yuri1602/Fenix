<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Училищна система за управление</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Fetch wrapper for mobile/tablet session support -->
    <script src="{{ url_for('static', filename='fetch-wrapper.js') }}"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-mortarboard-fill"></i> Училищна система</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown admin-only">
                        <a class="nav-link dropdown-toggle" href="#" id="materialsDropdown" role="button" 
                           data-bs-toggle="dropdown">
                            <i class="bi bi-box-seam"></i> Материали
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-section="materials-all">
                                <i class="bi bi-boxes"></i> Всички материали
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="materials-low">
                                <i class="bi bi-exclamation-triangle"></i> Намаляващи
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="materials-out">
                                <i class="bi bi-x-circle"></i> Изчерпани
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown admin-only">
                        <a class="nav-link dropdown-toggle" href="#" id="booksDropdown" role="button" 
                           data-bs-toggle="dropdown">
                            <i class="bi bi-book"></i> Учебници
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-section="books-textbooks">
                                <i class="bi bi-journal-text"></i> Учебници
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="books-workbooks">
                                <i class="bi bi-journal-bookmark"></i> Учебни тетрадки
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="requests">
                            <i class="bi bi-clipboard-check"></i> Заявки
                            <span id="pending-requests-badge" class="badge bg-danger ms-1" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" id="admin-menu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" 
                           data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> Администриране
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-section="users">
                                <i class="bi bi-people"></i> Потребители
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-section="categories">
                                <i class="bi bi-tags"></i> Категории (Материали)
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="publishers">
                                <i class="bi bi-building"></i> Издателства (Учебници)
                            </a></li>
                        </ul>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3">
                        <i class="bi bi-person-circle"></i> 
                        <span id="user-name">{{ user.full_name }}</span>
                        <small class="badge bg-light text-dark ms-1" id="user-role">{{ user.role }}</small>
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Изход
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4" id="main-content">
        <!-- Materials Section -->
        <div id="materials-all-section" class="content-section admin-only">
            <h2><i class="bi bi-box-seam"></i> Управление на материали</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-3" id="materials-stats">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-check-circle"></i> Налични</h5>
                            <h2 id="stat-available">0</h2>
                            <small>Материали с достатъчна наличност</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> Намаляващи</h5>
                            <h2 id="stat-low">0</h2>
                            <small>Материали с ниска наличност</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-x-circle"></i> Изчерпани</h5>
                            <h2 id="stat-out">0</h2>
                            <small>Материали без наличност</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-boxes"></i> Общо</h5>
                            <h2 id="stat-total">0</h2>
                            <small>Всички материали</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="materials-search" placeholder="Търсене...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="materials-category">
                                <option value="">Всички категории</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="materials-low-stock">
                                <label class="form-check-label" for="materials-low-stock">
                                    Само ниски количества
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadMaterials()">
                                <i class="bi bi-arrow-clockwise"></i> Обнови
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-success" onclick="showAddMaterialModal()">
                            <i class="bi bi-plus-circle"></i> Добави материал
                        </button>
                        <div>
                            <button class="btn btn-secondary" onclick="exportMaterials(false)">
                                <i class="bi bi-download"></i> Експорт всички
                            </button>
                            <button class="btn btn-warning" onclick="exportMaterials(true)">
                                <i class="bi bi-download"></i> Експорт ниски
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">Статус</th>
                                    <th width="30%">Име</th>
                                    <th width="15%">Категория</th>
                                    <th width="15%">Наличност</th>
                                    <th width="15%">Забележки</th>
                                    <th width="10%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="materials-tbody">
                                <tr><td colspan="6" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Low Stock Section -->
        <div id="materials-low-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-exclamation-triangle text-warning"></i> Намаляващи материали</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> Намаляващи</h5>
                            <h2 id="stat-low-page">0</h2>
                            <small>Материали под минималното количество</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-warning bg-opacity-25">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Материали с ниска наличност</h5>
                        <button class="btn btn-warning" onclick="exportMaterials(true)">
                            <i class="bi bi-download"></i> Експорт
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">Статус</th>
                                    <th width="30%">Име</th>
                                    <th width="15%">Категория</th>
                                    <th width="15%">Наличност / Праг</th>
                                    <th width="15%">Забележки</th>
                                    <th width="10%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="materials-low-tbody">
                                <tr><td colspan="6" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Out of Stock Section -->
        <div id="materials-out-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-x-circle text-danger"></i> Изчерпани материали</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-x-circle"></i> Изчерпани</h5>
                            <h2 id="stat-out-page">0</h2>
                            <small>Материали без наличност (0 бр)</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-danger bg-opacity-25">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-danger"><i class="bi bi-x-circle"></i> Материали без наличност</h5>
                        <button class="btn btn-danger" onclick="exportMaterials(true)">
                            <i class="bi bi-download"></i> Експорт
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>Внимание!</strong> Следните материали са изчерпани и трябва да се възобновят спешно!
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">Статус</th>
                                    <th width="35%">Име</th>
                                    <th width="20%">Категория</th>
                                    <th width="20%">Минимален праг</th>
                                    <th width="10%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="materials-out-tbody">
                                <tr><td colspan="5" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Books Section -->
                <!-- Books Textbooks Section -->
        <div id="books-textbooks-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-journal-text"></i> Управление на учебници</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="books-search" placeholder="Търсене по предмет...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="books-grade">
                                <option value="">Всички класове</option>
                                <option value="1">1 клас</option>
                                <option value="2">2 клас</option>
                                <option value="3">3 клас</option>
                                <option value="4">4 клас</option>
                                <option value="5">5 клас</option>
                                <option value="6">6 клас</option>
                                <option value="7">7 клас</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="books-publisher">
                                <option value="">Всички издателства</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="books-low-stock">
                                <label class="form-check-label" for="books-low-stock">
                                    Ниски количества
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadBooks('Учебник')">
                                <i class="bi bi-arrow-clockwise"></i> Обнови
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-success" onclick="showAddBookModal('Учебник')">
                            <i class="bi bi-plus-circle"></i> Добави учебник
                        </button>
                        <div>
                            <button class="btn btn-secondary" onclick="exportBooks('Учебник', false)">
                                <i class="bi bi-download"></i> Експорт всички
                            </button>
                            <button class="btn btn-warning" onclick="exportBooks('Учебник', true)">
                                <i class="bi bi-download"></i> Експорт ниски
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">Статус</th>
                                    <th width="25%">Предмет</th>
                                    <th width="8%">Клас</th>
                                    <th width="15%">Издателство</th>
                                    <th width="15%">Автор</th>
                                    <th width="12%">Наличност</th>
                                    <th width="10%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="books-tbody">
                                <tr><td colspan="7" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workbooks Section -->
                <!-- Books Workbooks Section -->
        <div id="books-workbooks-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-journal-bookmark"></i> Управление на учебни тетрадки</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="workbooks-search" placeholder="Търсене...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="workbooks-grade">
                                <option value="">Всички класове</option>
                                <option value="1">1 клас</option>
                                <option value="2">2 клас</option>
                                <option value="3">3 клас</option>
                                <option value="4">4 клас</option>
                                <option value="5">5 клас</option>
                                <option value="6">6 клас</option>
                                <option value="7">7 клас</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="workbooks-publisher">
                                <option value="">Всички издателства</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="workbooks-low-stock">
                                <label class="form-check-label" for="workbooks-low-stock">
                                    Ниски количества
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadBooks('Учебна тетрадка')">
                                <i class="bi bi-arrow-clockwise"></i> Обнови
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-success" onclick="showAddBookModal('Учебна тетрадка')">
                            <i class="bi bi-plus-circle"></i> Добави тетрадка
                        </button>
                        <div>
                            <button class="btn btn-secondary" onclick="exportBooks('Учебна тетрадка', false)">
                                <i class="bi bi-download"></i> Експорт всички
                            </button>
                            <button class="btn btn-warning" onclick="exportBooks('Учебна тетрадка', true)">
                                <i class="bi bi-download"></i> Експорт ниски
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">Статус</th>
                                    <th width="25%">Предмет</th>
                                    <th width="8%">Клас</th>
                                    <th width="15%">Издателство</th>
                                    <th width="15%">Автор</th>
                                    <th width="12%">Наличност</th>
                                    <th width="10%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="workbooks-tbody">
                                <tr><td colspan="7" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Management Section (Admin only) -->
                <!-- Users Section (Admin only) -->
        <div id="users-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-people"></i> Управление на потребители</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Потребители на системата</h5>
                        <button class="btn btn-success" onclick="showAddUserModal()">
                            <i class="bi bi-person-plus"></i> Добави потребител
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Потребителско име</th>
                                    <th>Пълно име</th>
                                    <th>Роля</th>
                                    <th>Компания</th>
                                    <th>Създаден</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody">
                                <tr><td colspan="6" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Management Section (Admin only) -->
                <!-- Categories Section (Admin only) -->
        <div id="categories-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-tags"></i> Управление на категории</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Категории за материали</h5>
                        <button class="btn btn-success" onclick="showAddCategoryModal()">
                            <i class="bi bi-plus-circle"></i> Добави категория
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 60%">Име на категория</th>
                                    <th style="width: 20%">Брой материали</th>
                                    <th style="width: 20%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="categories-tbody">
                                <tr><td colspan="3" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Publishers Management Section (Admin only) -->
        <div id="publishers-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-building"></i> Управление на издателства</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Издателства за учебници</h5>
                        <button class="btn btn-success" onclick="showAddPublisherModal()">
                            <i class="bi bi-plus-circle"></i> Добави издателство
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 60%">Име на издателство</th>
                                    <th style="width: 20%">Брой учебници</th>
                                    <th style="width: 20%">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="publishers-tbody">
                                <tr><td colspan="3" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Material Requests Section (All users) -->
        <div id="requests-section" class="content-section" style="display: none;">
            <h2><i class="bi bi-clipboard-check"></i> Заявки за материали</h2>
            
            <!-- Stats cards for admin -->
            <div id="requests-stats" class="row mb-3" style="display: none;">
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-hourglass-split"></i> Чакащи</h5>
                            <h2 id="stat-pending-requests">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-check-circle"></i> Одобрени</h5>
                            <h2 id="stat-approved-requests">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-x-circle"></i> Отказани</h5>
                            <h2 id="stat-rejected-requests">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-list-check"></i> Общо</h5>
                            <h2 id="stat-total-requests">0</h2>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters for admin -->
            <div id="requests-filters" class="card mb-3" style="display: none;">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Потребител</label>
                            <select class="form-select" id="filter-user">
                                <option value="">Всички потребители</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Материал</label>
                            <select class="form-select" id="filter-material">
                                <option value="">Всички материали</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="filter-status">
                                <option value="">Всички статуси</option>
                                <option value="pending">Чакащи</option>
                                <option value="approved">Одобрени</option>
                                <option value="rejected">Отказани</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">От дата</label>
                            <input type="date" class="form-control" id="filter-date-from">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">До дата</label>
                            <input type="date" class="form-control" id="filter-date-to">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button class="btn btn-primary" onclick="applyRequestsFilters()">
                                <i class="bi bi-funnel"></i> Приложи филтри
                            </button>
                            <button class="btn btn-secondary" onclick="clearRequestsFilters()">
                                <i class="bi bi-x-circle"></i> Изчисти
                            </button>
                            <button class="btn btn-success" onclick="exportRequestsToCSV()">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Експорт в CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Списък със заявки</h5>
                        <button class="btn btn-success" id="new-request-btn" onclick="showNewRequestModal()">
                            <i class="bi bi-plus-circle"></i> Нова заявка
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Статус</th>
                                    <th>Материал</th>
                                    <th>Категория</th>
                                    <th class="admin-only">Наличност</th>
                                    <th>Заявено</th>
                                    <th class="user-column admin-only">Потребител</th>
                                    <th>Дата</th>
                                    <th class="admin-only">Одобряване</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="requests-tbody">
                                <tr><td colspan="9" class="text-center">Зареждане...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will be added by JavaScript -->
    <div id="modals-container"></div>

    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Редактиране на заявка</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-request-id">
                    <div class="mb-3">
                        <label class="form-label">Материал</label>
                        <input type="text" class="form-control" id="edit-request-material" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Заявено количество</label>
                        <input type="number" class="form-control" id="edit-request-quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Забележка</label>
                        <textarea class="form-control" id="edit-request-notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Откажи</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedRequest()">Запази</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let currentSection = 'materials';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCurrentUser();
            initNavigation();
            // Don't call showSection here - it's called in loadCurrentUser based on role
        });

        // Load current user info
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-name').textContent = currentUser.full_name;
                    document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Админ' : 'Потребител';
                    
                    // Apply role-based styling
                    if (currentUser.role === 'admin') {
                        document.getElementById('admin-menu').style.display = 'block';
                        document.body.classList.add('admin-role');
                        // For admin, show materials by default
                        showSection('materials-all');
                    } else {
                        document.body.classList.add('user-role');
                        // For regular users, show only requests section by default
                        showSection('requests');
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error loading user:', error);
                window.location.href = '/login';
            }
        }

        // Initialize navigation
        function initNavigation() {
            document.querySelectorAll('[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        // Show specific section
        function showSection(section) {
            currentSection = section;
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected section
            const sectionEl = document.getElementById(section + '-section');
            if (sectionEl) {
                sectionEl.style.display = 'block';
            }
            
            // Load data based on section
            switch(section) {
                case 'materials-all':
                    loadMaterials('all');
                    loadMaterialsCategories();
                    break;
                case 'materials-low':
                    loadMaterials('low');
                    break;
                case 'materials-out':
                    loadMaterials('out');
                    break;
                case 'books-textbooks':
                    loadBooks('Учебник');
                    loadBooksPublishers();
                    break;
                case 'books-workbooks':
                    loadBooks('Учебна тетрадка');
                    loadBooksPublishers();
                    break;
                case 'users':
                    if (currentUser && currentUser.role === 'admin') {
                        loadUsers();
                    }
                    break;
                case 'categories':
                    if (currentUser && currentUser.role === 'admin') {
                        loadCategories();
                    }
                    break;
                case 'publishers':
                    if (currentUser && currentUser.role === 'admin') {
                        loadPublishers();
                    }
                    break;
                case 'requests':
                    loadRequests();
                    if (currentUser && currentUser.role === 'admin') {
                        loadRequestsStats();
                    }
                    break;
            }
            
            // Update active nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelectorAll(`[data-section="${section}"]`).forEach(link => {
                link.classList.add('active');
                link.closest('.nav-link')?.classList.add('active');
            });
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Error logging out:', error);
                window.location.href = '/login';
            }
        }

        // Helper function to get status badge
        function getStatusBadge(quantity, threshold) {
            if (quantity === 0) {
                return '<span class="badge bg-danger" style="font-size: 1.2rem;">🔴</span>';
            } else if (quantity <= threshold) {
                return '<span class="badge bg-warning" style="font-size: 1.2rem;">🟠</span>';
            } else {
                return '<span class="badge bg-success" style="font-size: 1.2rem;">🟢</span>';
            }
        }

        // Helper function for toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    <script src="{{ url_for('static', filename='materials.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='books.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='users.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='admin.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='requests.js') }}?v=9"></script>
</body>
</html>
