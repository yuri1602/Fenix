<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–∏–ª–∏—â–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Fetch wrapper for mobile/tablet session support -->
    <script src="{{ url_for('static', filename='fetch-wrapper.js') }}"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-mortarboard-fill"></i> –£—á–∏–ª–∏—â–Ω–∞ —Å–∏—Å—Ç–µ–º–∞</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown admin-only">
                        <a class="nav-link dropdown-toggle" href="#" id="materialsDropdown" role="button" 
                           data-bs-toggle="dropdown">
                            <i class="bi bi-box-seam"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª–∏
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-section="materials-all">
                                <i class="bi bi-boxes"></i> –í—Å–∏—á–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="materials-low">
                                <i class="bi bi-exclamation-triangle"></i> –ù–∞–º–∞–ª—è–≤–∞—â–∏
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="materials-out">
                                <i class="bi bi-x-circle"></i> –ò–∑—á–µ—Ä–ø–∞–Ω–∏
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown admin-only">
                        <a class="nav-link dropdown-toggle" href="#" id="booksDropdown" role="button" 
                           data-bs-toggle="dropdown">
                            <i class="bi bi-book"></i> –£—á–µ–±–Ω–∏—Ü–∏
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-section="books-textbooks">
                                <i class="bi bi-journal-text"></i> –£—á–µ–±–Ω–∏—Ü–∏
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="books-workbooks">
                                <i class="bi bi-journal-bookmark"></i> –£—á–µ–±–Ω–∏ —Ç–µ—Ç—Ä–∞–¥–∫–∏
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="requests">
                            <i class="bi bi-clipboard-check"></i> –ó–∞—è–≤–∫–∏
                            <span id="pending-requests-badge" class="badge bg-danger ms-1" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" id="admin-menu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" 
                           data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–∞–Ω–µ
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-section="users">
                                <i class="bi bi-people"></i> –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-section="categories">
                                <i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ú–∞—Ç–µ—Ä–∏–∞–ª–∏)
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-section="publishers">
                                <i class="bi bi-building"></i> –ò–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–∞ (–£—á–µ–±–Ω–∏—Ü–∏)
                            </a></li>
                        </ul>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3">
                        <i class="bi bi-person-circle"></i> 
                        <span id="user-name">{{ user.full_name }}</span>
                        <small class="badge bg-light text-dark ms-1" id="user-role">{{ user.role }}</small>
                    </span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> –ò–∑—Ö–æ–¥
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4" id="main-content">
        <!-- Materials Section -->
        <div id="materials-all-section" class="content-section admin-only">
            <h2><i class="bi bi-box-seam"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-3" id="materials-stats">
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-check-circle"></i> –ù–∞–ª–∏—á–Ω–∏</h5>
                            <h2 id="stat-available">0</h2>
                            <small>–ú–∞—Ç–µ—Ä–∏–∞–ª–∏ —Å –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> –ù–∞–º–∞–ª—è–≤–∞—â–∏</h5>
                            <h2 id="stat-low">0</h2>
                            <small>–ú–∞—Ç–µ—Ä–∏–∞–ª–∏ —Å –Ω–∏—Å–∫–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-x-circle"></i> –ò–∑—á–µ—Ä–ø–∞–Ω–∏</h5>
                            <h2 id="stat-out">0</h2>
                            <small>–ú–∞—Ç–µ—Ä–∏–∞–ª–∏ –±–µ–∑ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-boxes"></i> –û–±—â–æ</h5>
                            <h2 id="stat-total">0</h2>
                            <small>–í—Å–∏—á–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="materials-search" placeholder="–¢—ä—Ä—Å–µ–Ω–µ...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="materials-category">
                                <option value="">–í—Å–∏—á–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="materials-low-stock">
                                <label class="form-check-label" for="materials-low-stock">
                                    –°–∞–º–æ –Ω–∏—Å–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadMaterials()">
                                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-success" onclick="showAddMaterialModal()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏ –º–∞—Ç–µ—Ä–∏–∞–ª
                        </button>
                        <div>
                            <button class="btn btn-secondary" onclick="exportMaterials(false)">
                                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç –≤—Å–∏—á–∫–∏
                            </button>
                            <button class="btn btn-warning" onclick="exportMaterials(true)">
                                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç –Ω–∏—Å–∫–∏
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">–°—Ç–∞—Ç—É—Å</th>
                                    <th width="30%">–ò–º–µ</th>
                                    <th width="15%">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th width="15%">–ù–∞–ª–∏—á–Ω–æ—Å—Ç</th>
                                    <th width="15%">–ó–∞–±–µ–ª–µ–∂–∫–∏</th>
                                    <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="materials-tbody">
                                <tr><td colspan="6" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Low Stock Section -->
        <div id="materials-low-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-exclamation-triangle text-warning"></i> –ù–∞–º–∞–ª—è–≤–∞—â–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> –ù–∞–º–∞–ª—è–≤–∞—â–∏</h5>
                            <h2 id="stat-low-page">0</h2>
                            <small>–ú–∞—Ç–µ—Ä–∏–∞–ª–∏ –ø–æ–¥ –º–∏–Ω–∏–º–∞–ª–Ω–æ—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-warning bg-opacity-25">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª–∏ —Å –Ω–∏—Å–∫–∞ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç</h5>
                        <button class="btn btn-warning" onclick="exportMaterials(true)">
                            <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">–°—Ç–∞—Ç—É—Å</th>
                                    <th width="30%">–ò–º–µ</th>
                                    <th width="15%">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th width="15%">–ù–∞–ª–∏—á–Ω–æ—Å—Ç / –ü—Ä–∞–≥</th>
                                    <th width="15%">–ó–∞–±–µ–ª–µ–∂–∫–∏</th>
                                    <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="materials-low-tbody">
                                <tr><td colspan="6" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Out of Stock Section -->
        <div id="materials-out-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-x-circle text-danger"></i> –ò–∑—á–µ—Ä–ø–∞–Ω–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-x-circle"></i> –ò–∑—á–µ—Ä–ø–∞–Ω–∏</h5>
                            <h2 id="stat-out-page">0</h2>
                            <small>–ú–∞—Ç–µ—Ä–∏–∞–ª–∏ –±–µ–∑ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç (0 –±—Ä)</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-danger bg-opacity-25">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-danger"><i class="bi bi-x-circle"></i> –ú–∞—Ç–µ—Ä–∏–∞–ª–∏ –±–µ–∑ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç</h5>
                        <button class="btn btn-danger" onclick="exportMaterials(true)">
                            <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –°–ª–µ–¥–Ω–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏ —Å–∞ –∏–∑—á–µ—Ä–ø–∞–Ω–∏ –∏ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–µ –≤—ä–∑–æ–±–Ω–æ–≤—è—Ç —Å–ø–µ—à–Ω–æ!
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">–°—Ç–∞—Ç—É—Å</th>
                                    <th width="35%">–ò–º–µ</th>
                                    <th width="20%">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th width="20%">–ú–∏–Ω–∏–º–∞–ª–µ–Ω –ø—Ä–∞–≥</th>
                                    <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="materials-out-tbody">
                                <tr><td colspan="5" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Books Section -->
                <!-- Books Textbooks Section -->
        <div id="books-textbooks-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-journal-text"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—á–µ–±–Ω–∏—Ü–∏</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="books-search" placeholder="–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –ø—Ä–µ–¥–º–µ—Ç...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="books-grade">
                                <option value="">–í—Å–∏—á–∫–∏ –∫–ª–∞—Å–æ–≤–µ</option>
                                <option value="1">1 –∫–ª–∞—Å</option>
                                <option value="2">2 –∫–ª–∞—Å</option>
                                <option value="3">3 –∫–ª–∞—Å</option>
                                <option value="4">4 –∫–ª–∞—Å</option>
                                <option value="5">5 –∫–ª–∞—Å</option>
                                <option value="6">6 –∫–ª–∞—Å</option>
                                <option value="7">7 –∫–ª–∞—Å</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="books-publisher">
                                <option value="">–í—Å–∏—á–∫–∏ –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–∞</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="books-low-stock">
                                <label class="form-check-label" for="books-low-stock">
                                    –ù–∏—Å–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadBooks('–£—á–µ–±–Ω–∏–∫')">
                                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-success" onclick="showAddBookModal('–£—á–µ–±–Ω–∏–∫')">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏ —É—á–µ–±–Ω–∏–∫
                        </button>
                        <div>
                            <button class="btn btn-secondary" onclick="exportBooks('–£—á–µ–±–Ω–∏–∫', false)">
                                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç –≤—Å–∏—á–∫–∏
                            </button>
                            <button class="btn btn-warning" onclick="exportBooks('–£—á–µ–±–Ω–∏–∫', true)">
                                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç –Ω–∏—Å–∫–∏
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">–°—Ç–∞—Ç—É—Å</th>
                                    <th width="25%">–ü—Ä–µ–¥–º–µ—Ç</th>
                                    <th width="8%">–ö–ª–∞—Å</th>
                                    <th width="15%">–ò–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–æ</th>
                                    <th width="15%">–ê–≤—Ç–æ—Ä</th>
                                    <th width="12%">–ù–∞–ª–∏—á–Ω–æ—Å—Ç</th>
                                    <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="books-tbody">
                                <tr><td colspan="7" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Workbooks Section -->
                <!-- Books Workbooks Section -->
        <div id="books-workbooks-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-journal-bookmark"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —É—á–µ–±–Ω–∏ —Ç–µ—Ç—Ä–∞–¥–∫–∏</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="workbooks-search" placeholder="–¢—ä—Ä—Å–µ–Ω–µ...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="workbooks-grade">
                                <option value="">–í—Å–∏—á–∫–∏ –∫–ª–∞—Å–æ–≤–µ</option>
                                <option value="1">1 –∫–ª–∞—Å</option>
                                <option value="2">2 –∫–ª–∞—Å</option>
                                <option value="3">3 –∫–ª–∞—Å</option>
                                <option value="4">4 –∫–ª–∞—Å</option>
                                <option value="5">5 –∫–ª–∞—Å</option>
                                <option value="6">6 –∫–ª–∞—Å</option>
                                <option value="7">7 –∫–ª–∞—Å</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="workbooks-publisher">
                                <option value="">–í—Å–∏—á–∫–∏ –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–∞</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="workbooks-low-stock">
                                <label class="form-check-label" for="workbooks-low-stock">
                                    –ù–∏—Å–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                                </label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="loadBooks('–£—á–µ–±–Ω–∞ —Ç–µ—Ç—Ä–∞–¥–∫–∞')">
                                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <button class="btn btn-success" onclick="showAddBookModal('–£—á–µ–±–Ω–∞ —Ç–µ—Ç—Ä–∞–¥–∫–∞')">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏ —Ç–µ—Ç—Ä–∞–¥–∫–∞
                        </button>
                        <div>
                            <button class="btn btn-secondary" onclick="exportBooks('–£—á–µ–±–Ω–∞ —Ç–µ—Ç—Ä–∞–¥–∫–∞', false)">
                                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç –≤—Å–∏—á–∫–∏
                            </button>
                            <button class="btn btn-warning" onclick="exportBooks('–£—á–µ–±–Ω–∞ —Ç–µ—Ç—Ä–∞–¥–∫–∞', true)">
                                <i class="bi bi-download"></i> –ï–∫—Å–ø–æ—Ä—Ç –Ω–∏—Å–∫–∏
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">–°—Ç–∞—Ç—É—Å</th>
                                    <th width="25%">–ü—Ä–µ–¥–º–µ—Ç</th>
                                    <th width="8%">–ö–ª–∞—Å</th>
                                    <th width="15%">–ò–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–æ</th>
                                    <th width="15%">–ê–≤—Ç–æ—Ä</th>
                                    <th width="12%">–ù–∞–ª–∏—á–Ω–æ—Å—Ç</th>
                                    <th width="10%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="workbooks-tbody">
                                <tr><td colspan="7" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Management Section (Admin only) -->
                <!-- Users Section (Admin only) -->
        <div id="users-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-people"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞</h5>
                        <button class="btn btn-success" onclick="showAddUserModal()">
                            <i class="bi bi-person-plus"></i> –î–æ–±–∞–≤–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ</th>
                                    <th>–ü—ä–ª–Ω–æ –∏–º–µ</th>
                                    <th>–†–æ–ª—è</th>
                                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                    <th>–°—ä–∑–¥–∞–¥–µ–Ω</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="users-tbody">
                                <tr><td colspan="6" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Management Section (Admin only) -->
                <!-- Categories Section (Admin only) -->
        <div id="categories-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-tags"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</h5>
                        <button class="btn btn-success" onclick="showAddCategoryModal()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 60%">–ò–º–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th style="width: 20%">–ë—Ä–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª–∏</th>
                                    <th style="width: 20%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="categories-tbody">
                                <tr><td colspan="3" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Publishers Management Section (Admin only) -->
        <div id="publishers-section" class="content-section admin-only" style="display: none;">
            <h2><i class="bi bi-building"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–∞</h2>
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–ò–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–∞ –∑–∞ —É—á–µ–±–Ω–∏—Ü–∏</h5>
                        <button class="btn btn-success" onclick="showAddPublisherModal()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏ –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–æ
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 60%">–ò–º–µ –Ω–∞ –∏–∑–¥–∞—Ç–µ–ª—Å—Ç–≤–æ</th>
                                    <th style="width: 20%">–ë—Ä–æ–π —É—á–µ–±–Ω–∏—Ü–∏</th>
                                    <th style="width: 20%">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="publishers-tbody">
                                <tr><td colspan="3" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Material Requests Section (All users) -->
        <div id="requests-section" class="content-section" style="display: none;">
            <h2><i class="bi bi-clipboard-check"></i> –ó–∞—è–≤–∫–∏ –∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</h2>
            
            <!-- Stats cards for admin -->
            <div id="requests-stats" class="row mb-3" style="display: none;">
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-hourglass-split"></i> –ß–∞–∫–∞—â–∏</h5>
                            <h2 id="stat-pending-requests">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-check-circle"></i> –û–¥–æ–±—Ä–µ–Ω–∏</h5>
                            <h2 id="stat-approved-requests">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-x-circle"></i> –û—Ç–∫–∞–∑–∞–Ω–∏</h5>
                            <h2 id="stat-rejected-requests">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5><i class="bi bi-list-check"></i> –û–±—â–æ</h5>
                            <h2 id="stat-total-requests">0</h2>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters for admin -->
            <div id="requests-filters" class="card mb-3" style="display: none;">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</label>
                            <select class="form-select" id="filter-user">
                                <option value="">–í—Å–∏—á–∫–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                            <select class="form-select" id="filter-material">
                                <option value="">–í—Å–∏—á–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select class="form-select" id="filter-status">
                                <option value="">–í—Å–∏—á–∫–∏ —Å—Ç–∞—Ç—É—Å–∏</option>
                                <option value="pending">–ß–∞–∫–∞—â–∏</option>
                                <option value="approved">–û–¥–æ–±—Ä–µ–Ω–∏</option>
                                <option value="rejected">–û—Ç–∫–∞–∑–∞–Ω–∏</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">–û—Ç –¥–∞—Ç–∞</label>
                            <input type="date" class="form-control" id="filter-date-from">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">–î–æ –¥–∞—Ç–∞</label>
                            <input type="date" class="form-control" id="filter-date-to">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button class="btn btn-primary" onclick="applyRequestsFilters()">
                                <i class="bi bi-funnel"></i> –ü—Ä–∏–ª–æ–∂–∏ —Ñ–∏–ª—Ç—Ä–∏
                            </button>
                            <button class="btn btn-secondary" onclick="clearRequestsFilters()">
                                <i class="bi bi-x-circle"></i> –ò–∑—á–∏—Å—Ç–∏
                            </button>
                            <button class="btn btn-success" onclick="exportRequestsToCSV()">
                                <i class="bi bi-file-earmark-spreadsheet"></i> –ï–∫—Å–ø–æ—Ä—Ç –≤ CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">–°–ø–∏—Å—ä–∫ —Å—ä—Å –∑–∞—è–≤–∫–∏</h5>
                        <button class="btn btn-success" id="new-request-btn" onclick="showNewRequestModal()">
                            <i class="bi bi-plus-circle"></i> –ù–æ–≤–∞ –∑–∞—è–≤–∫–∞
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–ú–∞—Ç–µ—Ä–∏–∞–ª</th>
                                    <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                                    <th class="admin-only">–ù–∞–ª–∏—á–Ω–æ—Å—Ç</th>
                                    <th>–ó–∞—è–≤–µ–Ω–æ</th>
                                    <th class="user-column admin-only">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th class="admin-only">–û–¥–æ–±—Ä—è–≤–∞–Ω–µ</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="requests-tbody">
                                <tr><td colspan="9" class="text-center">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will be added by JavaScript -->
    <div id="modals-container"></div>

    <!-- Edit Request Modal -->
    <div class="modal fade" id="editRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –∑–∞—è–≤–∫–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-request-id">
                    <div class="mb-3">
                        <label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                        <input type="text" class="form-control" id="edit-request-material" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ó–∞—è–≤–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <input type="number" class="form-control" id="edit-request-quantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ó–∞–±–µ–ª–µ–∂–∫–∞</label>
                        <textarea class="form-control" id="edit-request-notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–∫–∞–∂–∏</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedRequest()">–ó–∞–ø–∞–∑–∏</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let currentSection = 'materials';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCurrentUser();
            initNavigation();
            // Don't call showSection here - it's called in loadCurrentUser based on role
        });

        // Load current user info
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('user-name').textContent = currentUser.full_name;
                    document.getElementById('user-role').textContent = currentUser.role === 'admin' ? '–ê–¥–º–∏–Ω' : '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';
                    
                    // Apply role-based styling
                    if (currentUser.role === 'admin') {
                        document.getElementById('admin-menu').style.display = 'block';
                        document.body.classList.add('admin-role');
                        // For admin, show materials by default
                        showSection('materials-all');
                    } else {
                        document.body.classList.add('user-role');
                        // For regular users, show only requests section by default
                        showSection('requests');
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error loading user:', error);
                window.location.href = '/login';
            }
        }

        // Initialize navigation
        function initNavigation() {
            document.querySelectorAll('[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        // Show specific section
        function showSection(section) {
            currentSection = section;
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected section
            const sectionEl = document.getElementById(section + '-section');
            if (sectionEl) {
                sectionEl.style.display = 'block';
            }
            
            // Load data based on section
            switch(section) {
                case 'materials-all':
                    loadMaterials('all');
                    loadMaterialsCategories();
                    break;
                case 'materials-low':
                    loadMaterials('low');
                    break;
                case 'materials-out':
                    loadMaterials('out');
                    break;
                case 'books-textbooks':
                    loadBooks('–£—á–µ–±–Ω–∏–∫');
                    loadBooksPublishers();
                    break;
                case 'books-workbooks':
                    loadBooks('–£—á–µ–±–Ω–∞ —Ç–µ—Ç—Ä–∞–¥–∫–∞');
                    loadBooksPublishers();
                    break;
                case 'users':
                    if (currentUser && currentUser.role === 'admin') {
                        loadUsers();
                    }
                    break;
                case 'categories':
                    if (currentUser && currentUser.role === 'admin') {
                        loadCategories();
                    }
                    break;
                case 'publishers':
                    if (currentUser && currentUser.role === 'admin') {
                        loadPublishers();
                    }
                    break;
                case 'requests':
                    loadRequests();
                    if (currentUser && currentUser.role === 'admin') {
                        loadRequestsStats();
                    }
                    break;
            }
            
            // Update active nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelectorAll(`[data-section="${section}"]`).forEach(link => {
                link.classList.add('active');
                link.closest('.nav-link')?.classList.add('active');
            });
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Error logging out:', error);
                window.location.href = '/login';
            }
        }

        // Helper function to get status badge
        function getStatusBadge(quantity, threshold) {
            if (quantity === 0) {
                return '<span class="badge bg-danger" style="font-size: 1.2rem;">üî¥</span>';
            } else if (quantity <= threshold) {
                return '<span class="badge bg-warning" style="font-size: 1.2rem;">üü†</span>';
            } else {
                return '<span class="badge bg-success" style="font-size: 1.2rem;">üü¢</span>';
            }
        }

        // Helper function for toast notifications
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    <script src="{{ url_for('static', filename='materials.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='books.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='users.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='admin.js') }}?v=9"></script>
    <script src="{{ url_for('static', filename='requests.js') }}?v=9"></script>
</body>
</html>
